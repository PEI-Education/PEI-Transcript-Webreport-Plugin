<queries>
  <query name="ca.pei.reporting.transcript.get_demographic_data" coreTable="students" flattened="true" tags="transcript">
    <summary>Student transcript data</summary>
    <description>Retrieves all data necessary to generate a PEI student transcript.</description>
		<columns>
			<column column="studentcorefields.pscore_legal_last_name">Transcript.Legal_Last_Name</column>
			<column column="studentcorefields.pscore_legal_first_name">Transcript.Legal_First_Name</column>
			<column column="studentcorefields.pscore_legal_middle_name">Transcript.Legal_Middle_Name</column>
      <column column="students.dcid">Transcript.Student_DCID</column>
			<column column="students.first_name">Transcript.First_Name</column>
			<column column="students.middle_name">Transcript.Middle_Name</column>
			<column column="students.last_name">Transcript.Last_Name</column>
			<column column="students.first_name">Transcript.Date_Of_Birth</column>
			<column column="students.id">Transcript.Student_ID</column>
			<column column="students.student_number">Transcript.Student_Number</column>
      <column column="students.home_room">Transcript.Homeroom</column> 
			<column column="ps_schoolenrollment.schoolid">Transcript.School_ID</column>
			<column column="schools.name">Transcript.School_Name</column>
			<column column="schools.schooladdress">Transcript.School_Address</column>
			<column column="schools.schoolcity">Transcript.School_City</column>
			<column column="schools.schoolstate">Transcript.School_State</column>
			<column column="schools.schoolzip">Transcript.School_Zip_Code</column>
			<column column="schools.schoolphone">Transcript.School_Phone_Number</column>
			<column column="u_def_ext_schools.schoolurl">Transcript.School_Website</column>
			<column column="u_def_ext_students.pei_hasgraduated">Transcript.GradY</column>
      <column column="u_def_ext_students.pei_hasgraduated">Transcript.GradN</column>
			<column column="u_def_ext_students.pei_hasgraduated">Transcript.Grad_Date</column>
			<column column="u_def_ext_students.pei_adpcertificate">Transcript.ADP</column>
			<column column="u_def_ext_students.pei_frenchcertificate">Transcript.French_Certificate</column>
			<column column="u_def_ext_students.pei_ib">Transcript.IB</column>
      <column column="gen.name">Transcript.ESAP</column>
      <column column="codeset.displayvalue">Transcript.ESAP_Selection</column>
		</columns>

    <sql><![CDATA[
        select
          scf.pscore_legal_last_name legal_last_name,
          scf.pscore_legal_first_name legal_first_name,
          scf.pscore_legal_middle_name legal_middle_name,
          
          s.dcid dcid,
          s.first_name first_name,
          s.middle_name middle_name,
          s.last_name last_name,
          to_char(s.dob, 'YYYY-MM-DD') dob,
          s.id id,
          s.student_number student_number,
          s.home_room homeroom,
          
          se.schoolid schoolid,
          sch.name schname,
          sch.schooladdress schaddress,
          sch.schoolcity schcity,
          sch.schoolstate schtate,
          sch.schoolzip schzip,
          sch.schoolphone schphone,
          
          schdyn.schoolurl schurl,
          
          case when substr(stuext.pei_hasgraduated, 0,1) = 'Y' then 1 else null end as gradY,
          case when substr(stuext.pei_hasgraduated, 0,1) <> 'Y' or stuext.pei_graduationdate is null then 1 else null end as gradN,
          to_char(stuext.pei_graduationdate, 'MM/DD/YYYY') pei_graduationdate,
          stuext.pei_adpcertificate adp,
          stuext.pei_frenchcertificate french_certificate,
          stuext.pei_ib ib,
           (select distinct
             case when gen.name = 'Essential Skills Achievement Pathway' then 1 else null end
           from SPEnrollments esap
           join GEN
             on GEN.id = esap.programid
           where
           gen.name = 'Essential Skills Achievement Pathway'
             and esap.studentid = s.id
             and (esap.exit_date >= SYSDATE OR esap.exitcode = 'GRAD')
         ) as esap,
          nvl(code.displayvalue, 'None') esapSelection
      from  (select dcid from students where <@restricted_table table="students" selector="selectedstudents"/>) sel
      join students s
              on s.dcid = sel.dcid
      join studentcorefields scf
              on scf.studentsdcid = s.dcid
      join ps_schoolenrollment se
              on se.studentid = s.id
              and se.yearid = 35
              and se.schoolid = 310
      join schools sch
              on sch.school_number = s.schoolid
      join u_def_ext_schools schdyn
              on schdyn.schoolsdcid = sch.dcid
      join u_def_ext_students stuext
              on stuext.studentsdcid = s.dcid
      left join codeset code
           on code.code = stuext.pei_esap
      order by s.last_name, s.first_name
    ]]></sql>
  </query>

  <query name="ca.pei.reporting.transcript.historical_grades" coreTable="StoredGrades" flattened="true">

		<description>Transcript data export - student grades</description>

		<columns>
			<column column="students.id">Transcript.Student_ID</column>
      <column column="storedgrades.course_name">Transcript.LastDay</column>
			<column column="storedgrades.credit_type">Transcript.Credit_Type</column>
			<column column="storedgrades.Course_Number">Transcript.Course_Number</column>
			<column column="storedgrades.Course_Name">Transcript.Course_Name</column>
			<column column="storedgrades.earnedcrhrs">Transcript.EawrnedCrHrs</column>
			<column column="storedgrades.potentialcrhrs">Transcript.PotentialCrHrs</column>
			<column column="storedgrades.grade">Transcript.Grade</column>
		</columns>

		<sql>
			<![CDATA[
				select
					s.id id,
          to_char(t.lastday,'yyyy/mm') as lastday,
          case sg.credit_type 
            when 'EN' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_EN]'
            when 'FR' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_FR]'
            when 'LA' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_LA]'
            when 'MA' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_MA]'
            when 'OP' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_OP]'
            when 'SC' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_SC]'
            when 'SH' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_SS]'
            when 'SS' then '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_SS]'
            when 'ESAP' then 'ESAP'
            else '~[text:psx.htmlc.admin_pei_transcript.pei_transcript.type_ZZ]'
          end as credit_type,
					sg.course_number course_number,
					sg.course_name course_name,
					sg.earnedcrhrs earnedcrhrs,
					sg.potentialcrhrs potentialcrhrs,
					sg.grade grade
				from (select dcid from students where <@restricted_table table="students" selector="selectedstudents"/>) sel
        join students s
					on s.dcid = sel.dcid
				join storedgrades sg
					on sg.studentid = s.id
				join terms t
					on t.id = sg.termid
				  and t.schoolid = s.schoolid
				where 
          sg.storecode = 'F1'
          and nvl(sg.ExcludeFromTranscripts,0) = 0
          order by s.id ASC, sg.credit_type ASC, t.lastday ASC
			]]>
		</sql>
	</query>

	<query name="ca.pei.reporting.transcript.current_courses" coreTable="cc" flattened="true">

		<description>Transcript data export - current courses</description>

		<columns>
			<column column="students.id">Transcript.Student_ID</column>
      <column column="cc.course_number">Transcript.Status</column>
			<column column="cc.course_number">Transcript.Course_Number</column>
			<column column="courses.course_name">Transcript.Course_Name</column>
			<column column="storedgrades.grade">Transcript.Current_Grade</column>
		</columns>

		<sql>
			<![CDATA[
          select
            s.id student_id,
            case
                when regs.DATEENROLLED <= SYSDATE then 'In Progress'
                when regs.DATEENROLLED > SYSDATE then 'Next Semester'
            end as status,
            regs.course_number course_number,
            c.course_name course_name,
            nvl(cg.grade,'-') as current_grade
          from (select dcid from students where <@restricted_table table="students" selector="selectedstudents"/>) sel
          join students s
              on s.dcid = sel.dcid
          join cc regs
              on regs.studentid = s.id
          join courses c
              on c.course_number = regs.course_number
          left join (select 
                  sg.studentid studentid,
                  sg.sectionid sectionid,
                  sg.course_number course_number, 
                  sg.grade grade, 
                  nvl(sg.excludefromtranscripts,0) excludeCourse 
              from storedgrades sg 
              where 1=1
              and substr(sg.termid,1,2) = 35
              and sg.storecode = 'Q1') cg
                  on s.id = cg.studentid
                  and regs.sectionid = cg.sectionid
          where
              substr(regs.termid,0,2) = 35
              and nvl(c.sched_do_not_print,0) = 0
              and nvl(cg.excludeCourse,0) = 0
              and regs.DATELEFT >= SYSDATE
          order by s.id, regs.DATEENROLLED, c.course_number
			]]>
		</sql>
	</query>
</queries>